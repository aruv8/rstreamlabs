<!-- обычная таблица. но:
* по клику на ячейке - она выделяется (почитай про установку фокуса, tabindex)
* при двойном клике входишь в режим редактирования ячейки (в ячейке появляется input). 
при клик-ауте из инпута (почитай - событие blur) или нажатии Enter инпут пропадает и его содержимое 
(то, что ты ввёл) записывается в ячейку. почитай про события клавиатуры (keydown, keypress).
никаких onclick=, все события вешай на ячейки с помощью jq. можно повесить на все ячейки одним махом -->

<!DOCTYPE html>
<html>
<head>
	<title>Lab 24 - Excel</title>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
	<style type="text/css">
		html {
			height: 100%;
		}

		body {
			/*height: 100%;
			min-width: 500px;*/
			background-color: #eee;
		}

		#outerdiv4table {
			position: relative;
			margin: 0;
			padding: 0;
		}

		/* Generated by jQuery to limit table width. Default width is in Object Constructor */
		#innerdiv4table {
			position: relative;
			margin: 0;
			padding: 0;
			border: 5px solid white;
			overflow: auto;
			box-sizing: border-box;
		}

		table {
			background-color: #e5e5e5;
			user-select: none;
		}
		table, td {
		    border: 1px solid black;
		    border-collapse: collapse;
		}

		td {
		    text-align: left;
		    height: 20px;
		    overflow: hidden;
		}

		td:focus {
			outline: 0px solid 0; 
			background-color: #a9c0e5; /* light blue */
		}

		table tr:first-child, td:first-child {
			background-color: #999;
			text-align: center;
		}

		table td:first-child {
			min-width: 50px;
			max-width: 50px;
		}

		table td:not(:first-child) {
			min-width: 100px;
			max-width: 100px;
		}

		input {
			display: fixed;
			position: relative;
			margin: 0;
			padding: 0;
			width: 96%;
			height: 16px;
		}

		#contextmenu {
			position: fixed;
			background-color: white;
			z-index: 1;
		}

		#contextmenu ul {
			margin: 0;
			padding: 0;
			user-select: none;
			list-style-type: none;
		}

		#contextmenu li {
		    height: 30px;
		    cursor: pointer;
		    border: 2px solid #00619d;
		}

		#contextmenu p {
		    margin: 0;
		    padding: 0 10px;
		    line-height: 30px;
		}

		#contextmenu li:hover {
			background-color: #bad0f4;

		}

	</style>
	<script type="text/javascript">
	
	/**
	 * Creates a Table.
	 *
	 * @constructor
	 * @this {ExcelTable}
	 * @param {object} 	data 					
	 * @param {object} 	data.append_to 			The container where a table should be created.
	 * @param {integer} data.rows 	[optional] 	The number ow table rows. Default 21.
	 * @param {integer} data.cols 	[optional]	The number of table columns. Default 11.
	 * @param {string}  data.width 	[optional] 	The width in pixels of the container with table. Default 800.
	 */
	function ExcelTable (data) {

		var xthis = this,
			$table,			// A new table.
			$context,		// TDs with attribute "context 1" (right-clickable rows).
			$content,		// TDs with attribute "tabindex 1" (data cells).
			$target_for_context_menu,	// Indicates particular row which was clicked on.
			flag_for_context_menu,		// Indicates if menu is currently shown
			col_n,			// The total current number of columns in the table.
			row_n;			// The total current number of the rows in the table.

		/**
		 * The very first initializations
		 */
		this.initialization = function() {
			xthis.generate_table();
			xthis.refresh_attributes();
			xthis.listen_event($context, $content);
		};

		/**
		 * Event listener for context menu. Runs only after a new menu generated.
		 *
		 * @param {object} menu1	(Li)
		 * @param {object} menu2	(Li)
		 */
		function listen_context_menu_event (menu1, menu2) {
			
			// click on menu 1 (add row)
			menu1.on("click", function () {
				add_row($target_for_context_menu);
			});

			// click on menu 2 (delete row)
			menu2.on("click", function () {
				xthis.delete_row($target_for_context_menu);
			});
		};	

		/**
		 * Applies attributes for the generated table
		 */
		this.apply_attributes = function () {
			$("tr:not(:first-child) td:not(:first-child)").attr({"tabindex":"1"}); // tabindex (makes tds "selectable")
			$("tr:not(:first-child) td:first-child").attr({"context":"1"});   	   // context (makes tds "right-clickable")
		};

		/**
		 * Creates a table by ExcelTable or default parameters
		 */
		this.generate_table = function () {
			var i, 
				j,
				$tr,			// A new TR 
				$td,			// A new TD
				$outerdiv,  	// The outer container where the table should be created
				$innerdiv,		// The inner container which has data.width parameter
				table_width,
				table_rows,
				table_columns;					    

			table_width = (data.width) || ("800px");// Default width is 800px or optional parameter from ExcelTable.
			table_rows = (data.rows) || (21);		// Default number is 21 table rows or optional parameter from ExcelTable.
			table_columns = (data.cols) || (11);	// Default number is 11 table columns or optional parameter from ExcelTable.
			$outerdiv = data.append_to;				// The container from ExcelTable, required parameter.
			$innerdiv = $("<div>").attr({"id":"innerdiv4table"}).css({"width":table_width}).appendTo($outerdiv);	// Creates inner container to limit table width
			$table = $("<table>").appendTo($innerdiv);
			
			for (i = 0; i < table_rows; i++) {
				$tr = $("<tr>").appendTo($table);
				for (j = 0; j < table_columns; j++) {
					$td = $("<td>").appendTo($tr);
					
					// initial table numeration
					if ((i == 0) && (j != 0)) {
						$td.text(j);
					}
					if ((i != 0) && (j == 0)) {
						$td.text(i);
					}
				}
			}
			
			col_n = table_columns;  // Globally stores the size of the table.
			row_n = table_rows;		//
			xthis.apply_attributes();
		};

		/**
		 * Numerates the table
		 */
		this.numerate_the_table = function () {
			
			// version 1
		    $.each($('tr:not(:first-child)'), function(index, row) {
		    $(row).children().eq(0).text(index + 1);
		    });

		    // version 2
		   /* var $allRows = $('tr');
		    for (var i = 1; i < $allRows.length; i++) {
		    $allRows.eq(i).children().eq(0).text(i);
		   }*/
		};
		
		/**
		 * Adds inputs in tds (reads td's value, stores input's value in td)
		 * @param {element} target
		 */	
		this.editmode = function (target) {
		 	var $input, 	// new input
				cell_value,
				cell_value2;//temporary storage of cell value as it destroyed later

		 	cell_value2 = cell_value = target.text(); // stores td's value twice; 
			target.text(""); // clears text in td to make a room for input
			$input = $("<input>").attr({"type":"text", "value":cell_value}).appendTo(target).focus();
			
			$input.keydown(function (e) {
				switch (e.keyCode) {
					case 13: 	// Enter key
					target.text($input.val()); 	 // writes input value to td
					$input.remove();     		 // destroys input
					xthis.shiftmode (target, 40);		 // goes down
					break;

					case 27: 	// Escape key
					$input.remove();
					$(target.text(cell_value2)).focus(); // "cell_value" doesn't exist; focus stays on this td
					break;
				}
			});

			$input.on("blur", function() {
				if ($input.val()) {
					target.text($input.val()); 
				}
				$input.remove();     			 
			});
		};

		/**
		 * Moves td's focus according to arrows on keyboard
		 * @param {object} target
		 * @param {integer} key
		 */
		this.shiftmode = function (target, key) {
			var col = target.index(),	// gets target "position" in table; the index function called with no parameters will get the position relative to its siblings
   				row = target.closest('tr').index(), //closest ancestor
   				$row;   // row element for up and down shifts

			switch (key) {	//left = 37, up = 38, right = 39, down = 40
					case 37: 	
						$(target.prev()).focus();
					break;
					case 38: 	
						$row = $(target.closest('tr')).prev(); // gets up on 1 lvl to closest tr (row)
						$($row.children()).eq(col).focus();    // goes in list of children (tds) and in particular element
					break;
					case 39: 	
						$(target.next()).focus();
					break;
					case 40: 	
						$row = $(target.closest('tr')).next(); // gets down on 1 lvl (1 row)
						$($row.children()).eq(col).focus();    // goes in list of children (tds) and in particular element
					break;
				}
		};

		/**
		 * Shows own context menu started in clicked coordinates
		 * @param {object} tar 	(target)
		 * @param {integer} l 	(left coordinates)
		 * @param {integer} t 	(top coordinates)
		 */
		this.context_menu = function (tar, l, t) {
			var	$menu1,		// area of the menu 1 (li)
				$menu2,		// area of the menu 2 (li)
				$container, // a container for the menu
				$ul,
				$li,
				$p;

			flag_for_context_menu = true;

			// Menu assembling
			$container = $("<div>").attr({"id":"contextmenu"}).appendTo(document.body);
			
			$ul = $("<ul>").appendTo($container);
			$li = $("<li>").attr({"name":"add_row"}).appendTo($ul);
			$menu1 = $li;	// Assigns current element to Menu 1
			
			$p = $("<p>").text("Add table row above").appendTo($li);
			$li = $("<li>").attr({"name":"delete_row"}).appendTo($ul);
			$menu2 = $li;	// Assigns current element to Menu 2
			$p = $("<p>").text("Delete current row").appendTo($li);

			// Changes colour of the row
			$context.css("background-color", "#999");	 // fills every context tds with default color
			$container.css({"top":t,"left":l}); 				 // positioning menu in a click point
			tar.css("background-color", "#0093d7");  	 // fills clicked context td with a blue color
			
			// Destroys context menu when clicked outside of it
			$("html").click(function() {
			    flag_for_context_menu = false;
			    $container.remove();
			    tar.css("background-color", "#999"); // fills clicked td with default color
			});

			// Runs event listener for context menu
			listen_context_menu_event($menu1, $menu2);
		}

		/**
		 * Adds a new table row above current. Global function
		 * @param {integer} row_number
		 */
		function add_row (target) {
			var i,
				$newtarget,		// TR instead of TD
				$new_context,
				$new_content,
				$tr,
				$td;

			row_n++;
			$newtarget = $(target.closest('tr'));
			$newtarget.before($tr = $("<tr>"));		// inserts new TR before current
			
			// Splits new table row to the amount of the table columns.
			for (i = 0; i < col_n; i++) {
				$td = $("<td>").appendTo($tr);
				
				//  
				if (i == 0) {
					$new_context = $td;	
				} 
			}

			$new_content = $("td:not(:first-child)", $tr); // the second way of select 

			xthis.apply_attributes();
			xthis.refresh_attributes();
			xthis.numerate_the_table();
			xthis.listen_event($new_context, $new_content); // have to start new event listener for the new row
		};

		/**
		 * Deletes current table row
		 * @param {object} target
		 */
		this.delete_row = function (target) {
			var $newtarget;

			row_n--;
			$newtarget = $(target.closest('tr'));
			$newtarget.remove();

			xthis.numerate_the_table();
		}

		/**
		 * Refreshes objects to operate with (after adding new ones)
		 */		
		this.refresh_attributes = function () {
			$content = $("table td[tabindex='1']");
			$context = $("table td[context='1']");
		}

		/**
		 * Catches events on table cells (focus, doubleclick, blur, Enter, Escape)
		 * 
		 * @param {object} $context 	(TDs - rows - with attribute "context 1". May be all of them or single new one.)
		 * @param {object} $content 	(TDs - columns - with attribute "content 1". May be all of them or single new row of ones.)
		 */
		this.listen_event = function ($context, $content) {
			
			// Right click on context tds
			$context.on("contextmenu", function (event) {
				event.preventDefault();		// disables default browser's context menu
				$target_for_context_menu = $(event.target);
				
				// Destroys an old menu if a new one already displayed
				if (flag_for_context_menu) {
					var $container = $("#contextmenu");
					$container.remove();
				}
					xthis.context_menu($target_for_context_menu, event.pageX, event.pageY);		// own context menu + coordinates
			});

			// Double click
			$content.on("dblclick", function (event) {
				var $target = $(event.target);
				xthis.editmode($target); 
			});
			
			// Focus and Keypress
			$content.on("keypress", function (event) {
				var $target = $(event.target);
				xthis.editmode($target); 
			});

			//left = 37, up = 38, right = 39, down = 40
			$content.on("keydown", function (event) {
				if ( (event.keyCode == 37) ||
					 (event.keyCode == 38) ||
					 (event.keyCode == 39) ||
					 (event.keyCode == 40)) {

					var $target = $(event.target);
					xthis.shiftmode($target, event.keyCode); 
				}	
			});
		};
		
		$(function() { 
			xthis.initialization();	
		});

	}	

	var excel_one = new ExcelTable({append_to: "#outerdiv4table", rows: 18, cols: 9});
	</script>
</head>
<body>
	<div id="outerdiv4table"></div>
</body>
</html>